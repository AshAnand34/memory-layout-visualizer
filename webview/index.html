<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memory Layout Visualizer</title>
    <!-- Content Security Policy with nonce -->
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://d3js.org 'nonce-abc123'; style-src 'self' vscode-resource:;">
    <script src="https://d3js.org/d3.v7.min.js" nonce="abc123"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <h1>Memory Layout Visualizer</h1>
    <div id="visualization">
        <div id="stack">
            <h2>Stack</h2>
            <ul id="stack-list"></ul>
        </div>
        <div id="heap">
            <h2>Heap</h2>
            <ul id="heap-list"></ul>
        </div>
    </div>
    <script nonce="abc123">
        console.log('Webview script is running.');

        // Ensure vscode object is available
        let vscode;
        try {
            vscode = acquireVsCodeApi();
            console.log('vscode object acquired successfully.');
        } catch (error) {
            console.error('Failed to acquire vscode object:', error);
        }

        // Function to render stack and heap data
        function renderMemoryLayout(stack, heap) {
            const stackList = d3.select("#stack-list");
            stackList.selectAll("li").remove();
            stack.forEach(frame => {
                const frameItem = stackList.append("li").text(frame.functionName);
                const variablesList = frameItem.append("ul");
                frame.variables.forEach(variable => {
                    variablesList.append("li").text(variable);
                });
            });

            const heapList = d3.select("#heap-list");
            heapList.selectAll("li").remove();
            heap.forEach(allocation => {
                heapList.append("li").text(allocation);
            });
        }

        // Confirm that the message listener is active
        console.log('Webview message listener is active.');
        window.addEventListener('message', (event) => {
            const message = event.data;
            // Add detailed debug logs to verify message reception
            console.log('Message received in Webview (detailed):', JSON.stringify(message, null, 2));
            if (message.type === 'memoryModel') {
                // Add detailed debug logs to verify message processing
                console.log('Rendering memory model with data (detailed):', JSON.stringify(message.data, null, 2));
                const { stack, heap } = message.data;
                console.log('Rendering memory layout with stack:', stack, 'and heap:', heap);
                renderMemoryLayout(stack, heap);
            }
        });

        // Notify the extension that the Webview is ready
        if (vscode) {
            window.addEventListener('load', () => {
                console.log('Webview loaded. Sending ready message to extension.');
                vscode.postMessage({ command: 'ready' });
            });
        } else {
            console.error('vscode object is not available. Cannot send ready message.');
        }
    </script>
</body>
</html>
